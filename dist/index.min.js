$(function(){function renderLi(e,t){var n=$('<li data-id="'+t+'" data-type="'+e.type+'" data-index="'+e.index+'"><input type="button" class="del" value="删除" /><input type="button" class="edit" value="编辑" /><span title="'+e.name+'" class="name">'+e.name+"</span></li>"),a=$type.eq(e.type-1).parent().data("name");if(!flags[e.type]){var i=$(".datas"),d=$('<div class="area area'+e.type+'">').appendTo(i);$("<ul>").appendTo(d),$("<h3>"+a+"</h3>").prependTo(d);flags[e.type]=!0}$(".area"+e.type).find("ul").append(n)}function renderAll(e){for(var t=0;t<max;t++)oIndexs[t+1]=0;flags={},$(".datas").empty();for(var n in e)e[n].index=oIndexs[e[n].type]++,renderLi(e[n],n)}function matchValue(){return""===$name.val()?(alert("请填写视频名称"),!1):""!==$code.val()||(alert("请填写视频代码"),!1)}function setValue(e){e?($name.val(e.name),$code.val(e.code),$type.eq(e.type-1).prop("checked",!0)):($name.val(""),$code.val(""),$type.eq(0).prop("checked",!0),$selector.val(0))}function updateData(){$checked=$('input[name="videoType"]:checked'),baseTree[listID][id]={name:$name.val(),code:$code.val(),type:$checked.val(),index:baseTree[listID][id].index},iRadio=baseTree[listID][id].type,sortData(baseTree[listID][id])}function sortData(e){var t=$selector.val();if(1==t)if(0==e.index)console.log("已经是第一个了");else{var n=findObj(baseTree[listID],e.type,e.index-1),a=$.extend(!0,{},baseTree[listID][n]);baseTree[listID][n]=e,baseTree[listID][id]=a}if(2==t)if(e.index>=oIndexs[e.type]-1)console.log("已经是最后一个了");else{var i=findObj(baseTree[listID],e.type,e.index+1),a=$.extend(!0,{},baseTree[listID][i]);baseTree[listID][i]=e,baseTree[listID][id]=a}}function findObj(e,t,n){for(var a in e){var i=e[a];if(i.type==t&&i.index==n)return a}}function showResult(){$("#result").html(format(JSON.stringify(baseTree),!1))}function format(txt,compress){var indentChar="    ";if(/^\s*$/.test(txt))return void alert("数据为空,无法格式化! ");try{var data=eval("("+txt+")")}catch(e){return void alert("数据源语法错误,格式化失败! 错误信息: "+e.description,"err")}var draw=[],last=!1,This=this,line=compress?"":"\n",nodeCount=0,maxDepth=0,notify=function(e,t,n,a,i){nodeCount++;for(var d=0,s="";d<a;d++)s+=indentChar;if(s=compress?"":s,maxDepth=++a,t&&t.constructor==Array){draw.push(s+(i?'"'+e+'":':"")+"["+line);for(var d=0;d<t.length;d++)notify(d,t[d],d==t.length-1,a,!1);draw.push(s+"]"+(n?line:","+line))}else if(t&&"object"==typeof t){draw.push(s+(i?'"'+e+'":':"")+"{"+line);var l=0,d=0;for(var o in t)l++;for(var o in t)notify(o,t[o],++d==l,a,!0);draw.push(s+"}"+(n?line:","+line))}else"string"==typeof t&&(t='"'+t+'"'),draw.push(s+(i?'"'+e+'":':"")+t+(n?"":",")+line)},isLast=!0,indent=0;return notify("",data,isLast,indent,!1),draw.join("")}var id,baseTree={1000:{1468028955456:{name:"分类1",code:"1",type:"1",index:21},1468028966102:{name:"分类2",code:"2",type:"1",index:22},1468028969572:{name:"标题1",code:"1",type:"2",index:14},1468028974779:{name:"标题2",code:"2",type:"2",index:15},1468028985708:{name:"底部1",code:"1",type:"3",index:14},1468028990846:{name:"底部2",code:"2",type:"3",index:15},1468073132243:{name:"分类3",code:"3",type:"1",index:23}},1001:{1468029214695:{name:"aaa",code:"1",type:"3"},1468029220959:{name:"bbb",code:"1",type:"2"}}},$context=$("#d2"),$name=$context.find("#videoName"),$code=$context.find("#videoCode"),$type=$context.find('input[name="videoType"]'),$selector=$(".f-select"),$checked,iRadio=1,listID,max=$type.length,flags={},oIndexs={},d1=dialog({id:"d1",title:"添加视频 step1",width:400,height:400,okValue:"保存",ok:function(){return this.close(),showResult(),!1},cancel:function(){return this.close(),!1},cancelDisplay:!1,content:document.getElementById("d1")}),d2=dialog({id:"d2",title:"添加视频 step2",okValue:"保存",ok:function(){return matchValue()&&(updateData(),renderAll(baseTree[listID]),this.close(),setValue(null)),!1},cancel:function(){return this.close(),setValue(null),!1},cancelDisplay:!1,content:document.getElementById("d2")});$(".btnAddVideo").on("click",function(){listID=$(this).data("listid"),$.isEmptyObject(baseTree[listID])&&(baseTree[listID]={}),renderAll(baseTree[listID]),d1.showModal()}),$("#btnAddVideoList").on("click",function(){$(".f-li-select").hide(),id=+new Date,baseTree[listID][id]={},d2.showModal()}),$(".datas").on("click",".edit",function(){$(".f-li-select").show();var e=$(this).parent("li");id=e.data("id"),setValue(baseTree[listID][id]),d2.showModal()}),$(".datas").on("click",".del",function(){var e=$(this).parent("li"),t=e.data("id"),n=$(this).siblings(".name").text();dialog({title:"警告",width:220,content:"确认要删除<b>"+n+"</b>吗？",ok:function(){e.remove(),delete baseTree[listID][t],renderAll(baseTree[listID])}}).showModal()}),$('input[name="videoType"]').on("change",function(){iRadio=$(this).val()})});